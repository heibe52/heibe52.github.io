<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klavier Harmonielehre Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --key-width: 42px;
            --key-height: 160px;
        }
        
        body {
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }

        /* --- LOADER --- */
        #app-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
        }

        .loader-ring {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(59, 130, 246, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* 3D Piano Styling */
        .piano-scroll-wrapper {
            display: flex;
            justify-content: center;
            overflow-x: auto;
            padding: 20px 0 5px 0;
            width: 100%;
            scrollbar-width: thin;
            scrollbar-color: #475569 #1e293b;
        }

        .piano-container {
            position: relative;
            height: auto;
            user-select: none;
            margin: 0 auto;
            display: flex;
            background: linear-gradient(180deg, #1e1e1e 0%, #000000 100%);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.8),
                inset 0 1px 1px rgba(255,255,255,0.1);
            border-top: 4px solid #334155;
        }

        .white-key {
            width: var(--key-width);
            height: var(--key-height);
            background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 85%, #cbd5e1 100%);
            border: 1px solid #94a3b8;
            border-top: none;
            border-radius: 0 0 4px 4px;
            position: relative;
            z-index: 1;
            cursor: pointer;
            flex-shrink: 0;
            margin-right: 1px;
            box-shadow: inset 0 -5px 8px rgba(0,0,0,0.1);
            transition: transform 0.05s ease, background 0.1s;
        }

        .white-key:active, .white-key.active {
            background: linear-gradient(180deg, #93c5fd 0%, #3b82f6 100%) !important;
            border-bottom: 1px solid #1d4ed8;
            transform: translateY(2px) scale(0.99); 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }

        .black-key {
            width: calc(var(--key-width) * 0.6);
            height: calc(var(--key-height) * 0.65);
            background: linear-gradient(180deg, #334155 0%, #020617 100%);
            position: absolute;
            z-index: 10;
            border-radius: 0 0 3px 3px;
            cursor: pointer;
            border: 1px solid #000;
            border-top: none;
            box-shadow: 2px 4px 6px rgba(0,0,0,0.5), inset 0 2px 3px rgba(255,255,255,0.15);
            transition: transform 0.05s ease, background 0.1s;
        }

        .black-key:active, .black-key.active {
            background: linear-gradient(180deg, #2563eb 0%, #172554 100%) !important;
            transform: translateY(2px) scale(0.98);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);
        }

        /* Black Key Positioning */
        .bk-pos-0 { left: calc(var(--key-width) * 0.65); } 
        .bk-pos-1 { left: calc(var(--key-width) * 1.75); } 
        .bk-pos-2 { left: calc(var(--key-width) * 3.75); } 
        .bk-pos-3 { left: calc(var(--key-width) * 4.80); } 
        .bk-pos-4 { left: calc(var(--key-width) * 5.85); } 

        .note-label {
            position: absolute;
            bottom: 8px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #64748b;
            font-size: 11px;
            font-weight: 800;
            pointer-events: none;
            opacity: 0.7;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .white-key.active .note-label, .black-key.active .note-label {
            color: white;
            opacity: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8); 
        }

        /* Matrix Styling */
        .matrix-row:hover { background-color: #334155; cursor: pointer; }
        .matrix-row.active-row { background-color: #1e3a8a; border-left: 4px solid #60a5fa; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center min-h-screen">

    <!-- PRELOADER -->
    <div id="app-loader">
        <div class="loader-ring"></div>
        <h1 class="text-2xl font-bold text-white tracking-widest uppercase mb-2">Harmonie Engine Pro</h1>
        <p class="text-xs text-blue-400 font-mono" id="loader-status">Initialisiere Audio-Core...</p>
        <p class="mt-8 text-[10px] text-slate-600">Â© 2025 Heiko Behnken</p>
    </div>

    <div class="w-full max-w-5xl bg-slate-900 p-6 rounded-xl shadow-2xl border border-slate-800">
        <!-- Header -->
        <header class="mb-8 border-b border-slate-700 pb-4 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
            <div>
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">
                    Harmonie Engine Pro
                </h1>
                <p class="text-slate-400 text-sm mt-1">Interaktive Harmonielehre mit Audio-Engine & Enharmonik</p>
            </div>
            
            <div class="flex gap-3">
                 <button id="toggleSoundBtn" class="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded text-xs text-slate-300 transition-all">
                    <span id="soundIcon">ðŸ”‡</span> Audio inaktiv
                </button>
            </div>
        </header>

        <!-- Controls -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                <label class="block text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">Tonart (Kontext)</label>
                <select id="rootSelect" class="w-full bg-slate-900 text-white p-2 rounded border border-slate-700 focus:border-blue-500 focus:outline-none">
                    <!-- JS generated -->
                </select>
            </div>
            
            <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                <label class="block text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">Aktueller Akkord-Typ</label>
                <select id="typeSelect" class="w-full bg-slate-900 text-white p-2 rounded border border-slate-700 focus:border-blue-500 focus:outline-none">
                    <optgroup label="DreiklÃ¤nge">
                        <option value="maj">Dur (Major)</option>
                        <option value="min">Moll (Minor)</option>
                        <option value="dim">Vermindert (dim)</option>
                        <option value="aug">ÃœbermÃ¤ÃŸig (aug)</option>
                        <option value="sus2">Sus2</option>
                        <option value="sus4">Sus4</option>
                    </optgroup>
                    <optgroup label="Septakkorde">
                        <option value="7">Dominant 7</option>
                        <option value="maj7">Major 7</option>
                        <option value="min7">Minor 7</option>
                        <option value="m7b5">Halbvermindert (m7b5)</option>
                        <option value="dim7">Vollvermindert (dim7)</option>
                        <option value="minmaj7">Moll/Major 7</option>
                    </optgroup>
                    <optgroup label="Erweiterungen">
                         <option value="6">Dur 6</option>
                         <option value="m6">Moll 6</option>
                         <option value="9">Dominant 9</option>
                         <option value="min9">Minor 9</option>
                         <option value="maj9">Major 9</option>
                    </optgroup>
                </select>
            </div>

            <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                <label class="block text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">Umkehrung & Voicing</label>
                <select id="inversionSelect" class="w-full bg-slate-900 text-white p-2 rounded border border-slate-700 focus:border-blue-500 focus:outline-none">
                    <option value="-2">â–¼ 2. Umkehrung (tief)</option>
                    <option value="-1">â–¼ 1. Umkehrung (tief)</option>
                    <option value="0" selected>Grundstellung</option>
                    <option value="1">â–² 1. Umkehrung (hoch)</option>
                    <option value="2">â–² 2. Umkehrung (hoch)</option>
                    <option value="3">â–² 3. Umkehrung (hoch)</option>
                </select>
            </div>

             <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                <label class="block text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">Matrix Skala</label>
                <select id="scaleContextSelect" class="w-full bg-slate-900 text-white p-2 rounded border border-slate-700 focus:border-blue-500 focus:outline-none">
                    <option value="major">Dur (Ionian)</option>
                    <option value="minor">NatÃ¼rlich Moll (Aeolian)</option>
                </select>
            </div>
        </div>

        <!-- Info Display -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-1 mb-8">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-l-lg border-y border-l border-slate-700 flex flex-col justify-center text-center">
                <span class="text-xs text-slate-500 uppercase font-bold tracking-widest">Aktiver Akkord</span>
                <span id="chordNameDisplay" class="text-4xl font-black text-white mt-1">C Major</span>
            </div>
            <div class="bg-slate-800/80 p-6 border-y border-slate-700 flex flex-col justify-center text-center backdrop-blur-sm">
                <span class="text-xs text-slate-500 uppercase font-bold tracking-widest">TÃ¶ne (Enharmonisch)</span>
                <span id="notesDisplay" class="text-2xl font-mono text-blue-300 mt-1">C - E - G</span>
            </div>
            <div class="bg-slate-800/80 p-6 rounded-r-lg border-y border-r border-slate-700 flex flex-col justify-center text-center">
                <span class="text-xs text-slate-500 uppercase font-bold tracking-widest">Intervalle</span>
                <span id="intervalsDisplay" class="text-xl font-mono text-emerald-400 mt-1">1 - 3 - 5</span>
            </div>
        </div>

        <!-- Piano -->
        <div class="piano-scroll-wrapper" id="pianoWrapper">
            <div class="piano-container" id="piano">
                <!-- Generated by JS -->
            </div>
        </div>
        
        <!-- Play Controls Below Piano -->
        <div class="flex flex-col items-center justify-center gap-2 mt-4 mb-8">
             <button onclick="playCurrentChord()" class="flex items-center gap-2 px-12 py-3 bg-blue-600 hover:bg-blue-500 rounded-full text-white font-bold text-lg shadow-[0_0_20px_rgba(37,99,235,0.3)] transition-all active:scale-95 active:shadow-none hover:shadow-[0_0_30px_rgba(37,99,235,0.5)]">
                <span class="text-xl">â–¶</span> Akkord abspielen
            </button>
            <p class="text-center text-xs text-slate-500">Oder klicke direkt auf die Tasten</p>
        </div>

        <!-- Matrix -->
        <div class="border-t border-slate-700 pt-8">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-200">Harmonische Matrix</h3>
                <span id="scaleLabel" class="text-xs bg-slate-800 px-2 py-1 rounded text-blue-400 border border-slate-700">C Dur Kontext</span>
            </div>
            
            <div class="overflow-hidden rounded-lg border border-slate-700">
                <table class="w-full text-sm text-left text-slate-400">
                    <thead class="text-xs text-slate-300 uppercase bg-slate-950">
                        <tr>
                            <th class="px-4 py-3 w-12">#</th>
                            <th class="px-4 py-3">Stufe (Roman)</th>
                            <th class="px-4 py-3">Funktion</th>
                            <th class="px-4 py-3">Dreiklang</th>
                            <th class="px-4 py-3">Septakkord</th>
                        </tr>
                    </thead>
                    <tbody id="matrixBody" class="divide-y divide-slate-800 bg-slate-900/50">
                        <!-- JS generated -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Theory Text -->
        <div class="mt-8 p-4 bg-blue-900/20 border border-blue-900/50 rounded-lg">
            <h4 class="text-blue-400 font-bold mb-1 text-sm">Theoretischer Kontext</h4>
            <p id="theoryDesc" class="text-slate-300 text-sm leading-relaxed"></p>
        </div>
    </div>

    <script>
        // --- DATA & CONSTANTS ---
        const sharpNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const flatNotes =  ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        
        const flatKeys = new Set([5, 10, 3, 8, 1, 6]); 
        
        const chordDefinitions = {
            'maj': { name: 'Dur', intervals: [0, 4, 7], desc: 'Der Dur-Dreiklang ist der stabilste Klang der westlichen Musik.', struct: '1 - 3 - 5' },
            'min': { name: 'Moll', intervals: [0, 3, 7], desc: 'Moll wirkt trauriger oder ernster durch die kleine Terz.', struct: '1 - b3 - 5' },
            'dim': { name: 'Vermindert', intervals: [0, 3, 6], desc: 'Dissonant und instabil. Besteht aus zwei kleinen Terzen.', struct: '1 - b3 - b5' },
            'aug': { name: 'ÃœbermÃ¤ÃŸig', intervals: [0, 4, 8], desc: 'Spannungsgeladen und schwebend durch die Ã¼bermÃ¤ÃŸige Quinte.', struct: '1 - 3 - #5' },
            'sus2': { name: 'Sus2', intervals: [0, 2, 7], desc: 'Offener Klang ohne Terz. Schwebend.', struct: '1 - 2 - 5' },
            'sus4': { name: 'Sus4', intervals: [0, 5, 7], desc: 'Quartharmonik. MÃ¶chte sich oft zur Terz auflÃ¶sen.', struct: '1 - 4 - 5' },
            '7': { name: 'Dom 7', intervals: [0, 4, 7, 10], desc: 'Der klassische Dominantseptakkord. Erzeugt starke Spannung.', struct: '1 - 3 - 5 - b7' },
            'maj7': { name: 'Maj 7', intervals: [0, 4, 7, 11], desc: 'Jazzig, weich, nostalgisch. GroÃŸe Septime auf Dur.', struct: '1 - 3 - 5 - 7' },
            'min7': { name: 'Min 7', intervals: [0, 3, 7, 10], desc: 'Der Standard-Jazz-Mollakkord.', struct: '1 - b3 - 5 - b7' },
            'm7b5': { name: 'Halbverm.', intervals: [0, 3, 6, 10], desc: 'Auch Moll7b5. Wichtig als II. Stufe in Moll.', struct: '1 - b3 - b5 - b7' },
            'dim7': { name: 'Vollverm.', intervals: [0, 3, 6, 9], desc: 'Symmetrischer Klang. Jedes Intervall ist eine kleine Terz.', struct: '1 - b3 - b5 - bb7' },
            'minmaj7': { name: 'Min/Maj7', intervals: [0, 3, 7, 11], desc: 'Klingt mysteriÃ¶s und filmisch (Film Noir).', struct: '1 - b3 - 5 - 7' },
            '6': { name: 'Dur 6', intervals: [0, 4, 7, 9], desc: 'Alternative zur Maj7, stabiler und weniger "wolkig".', struct: '1 - 3 - 5 - 6' },
            'm6': { name: 'Moll 6', intervals: [0, 3, 7, 9], desc: 'Dorian Sound. Sehr charakteristisch.', struct: '1 - b3 - 5 - 6' },
            '9': { name: 'Dom 9', intervals: [0, 4, 7, 10, 14], desc: 'FÃ¼nfstimmiger Funk-Klang.', struct: '1 - 3 - 5 - b7 - 9' },
            'min9': { name: 'Min 9', intervals: [0, 3, 7, 10, 14], desc: 'Sehr tiefer, warmer Moll-Klang.', struct: '1 - b3 - 5 - b7 - 9' },
            'maj9': { name: 'Maj 9', intervals: [0, 4, 7, 11, 14], desc: 'Breit, luxuriÃ¶s und modern.', struct: '1 - 3 - 5 - 7 - 9' }
        };

        const diatonicMajor = [
            { step: 'I',   off: 0, tri: 'maj', sev: 'maj7', func: 'Tonika' },
            { step: 'ii',  off: 2, tri: 'min', sev: 'min7', func: 'Subdom. Parallele' },
            { step: 'iii', off: 4, tri: 'min', sev: 'min7', func: 'Dominant Parallele' },
            { step: 'IV',  off: 5, tri: 'maj', sev: 'maj7', func: 'Subdominante' },
            { step: 'V',   off: 7, tri: 'maj', sev: '7',    func: 'Dominante' },
            { step: 'vi',  off: 9, tri: 'min', sev: 'min7', func: 'Tonika Parallele' },
            { step: 'viiÂ°',off: 11, tri: 'dim', sev: 'm7b5', func: 'Leitton' }
        ];

        const diatonicMinor = [
            { step: 'i',   off: 0, tri: 'min', sev: 'min7', func: 'Tonika' },
            { step: 'iiÂ°', off: 2, tri: 'dim', sev: 'm7b5', func: 'Subdom. Parallele' },
            { step: 'III', off: 3, tri: 'maj', sev: 'maj7', func: 'Tonika Parallele' },
            { step: 'iv',  off: 5, tri: 'min', sev: 'min7', func: 'Subdominante' },
            { step: 'v',   off: 7, tri: 'min', sev: 'min7', func: 'Dominante (Nat)' },
            { step: 'VI',  off: 8, tri: 'maj', sev: 'maj7', func: 'Subdominant Gegenk.' },
            { step: 'VII', off: 10, tri: 'maj', sev: '7',   func: 'Dominant Parallele' }
        ];

        // --- AUDIO ENGINE ---
        let audioCtx;
        let masterGain;
        let isAudioEnabled = true; // MASTER SWITCH - Start with Audio ON

        async function toggleAudio() {
            // Simply flip the switch. We don't necessarily need to suspend context here,
            // just blocking the gate in playFreq is enough and safer.
            isAudioEnabled = !isAudioEnabled;
            
            // Optional: If enabling, try to resume if suspended
            if (isAudioEnabled && audioCtx && audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }
            
            updateAudioUI(isAudioEnabled);
        }

        async function initAudio() {
            if (audioCtx) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.3; // Prevent clipping
            masterGain.connect(audioCtx.destination);
            
            updateAudioUI(isAudioEnabled);
        }

        function updateAudioUI(isActive) {
            const btn = document.getElementById('toggleSoundBtn');
            if (isActive) {
                btn.classList.remove('bg-slate-800', 'text-slate-300', 'border-slate-600');
                btn.classList.add('bg-green-800', 'text-white', 'border-green-600');
                btn.innerHTML = '<span>ðŸ”Š</span> Audio Aktiv';
            } else {
                btn.classList.add('bg-slate-800', 'text-slate-300', 'border-slate-600');
                btn.classList.remove('bg-green-800', 'text-white', 'border-green-600');
                btn.innerHTML = '<span>ðŸ”‡</span> Audio Inaktiv';
            }
        }

        function playFreq(freq, duration = 1.5, delay = 0) {
            // GATEKEEPER: If user wants mute, we stop right here.
            if (!isAudioEnabled) return;

            // Check context exists.
            if (!audioCtx) return;
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.type = 'triangle'; 
            osc.frequency.value = freq;
            
            // Envelope
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime + delay);
            gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + delay + 0.05); // Attack
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration); // Decay
            
            osc.connect(gainNode);
            gainNode.connect(masterGain);
            
            osc.start(audioCtx.currentTime + delay);
            osc.stop(audioCtx.currentTime + delay + duration);
        }

        function getFrequency(noteIndex) {
            // A4 = 440Hz is note index 57 (if C0 is 0)
            const midiNote = noteIndex + 48; 
            return 440 * Math.pow(2, (midiNote - 69) / 12);
        }

        // --- APP STATE ---
        const state = {
            contextRoot: 0,     // The "Key" (e.g., C Major)
            activeRoot: 0,      // The "Chord" being played
            activeType: 'maj',  // The quality of the active chord
            inversion: 0,
            scaleContext: 'major' 
        };

        // --- DOM ELEMENTS ---
        const rootSelect = document.getElementById('rootSelect');
        const typeSelect = document.getElementById('typeSelect');
        const inversionSelect = document.getElementById('inversionSelect');
        const scaleContextSelect = document.getElementById('scaleContextSelect');
        const pianoContainer = document.getElementById('piano');
        const matrixBody = document.getElementById('matrixBody');
        const toggleSoundBtn = document.getElementById('toggleSoundBtn');

        // --- LOGIC ---
        function getNoteName(index, contextRoot = null) {
            const normalized = index % 12;
            if (normalized < 0) return getNoteName(normalized + 12, contextRoot); // Handle negative indices

            let useFlat = false;

            if (contextRoot !== null) {
                if (flatKeys.has(contextRoot)) useFlat = true;
            } else {
                if (flatKeys.has(state.contextRoot)) useFlat = true;
            }

            return useFlat ? flatNotes[normalized] : sharpNotes[normalized];
        }

        function init() {
            sharpNotes.forEach((note, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = `${note} / ${flatNotes[idx]}`;
                rootSelect.add(opt);
            });

            generatePiano();
            updateAll(); 

            // Initialize Audio immediately
            initAudio();

            // Setup loading screen removal
            window.addEventListener('load', () => {
                const loader = document.getElementById('app-loader');
                const status = document.getElementById('loader-status');
                
                // Sequence fake loading steps for better UX
                setTimeout(() => { status.textContent = "Lade Interface Module..."; }, 300);
                setTimeout(() => { status.textContent = "Fertig."; }, 800);
                
                setTimeout(() => {
                    loader.style.opacity = '0';
                    loader.style.visibility = 'hidden';
                    document.body.style.overflow = 'auto'; // Re-enable scrolling
                }, 1000);
            });

            // Listeners
            rootSelect.addEventListener('change', (e) => { 
                state.contextRoot = parseInt(e.target.value); 
                state.activeRoot = state.contextRoot; 
                updateAll(); 
                playCurrentChord(); 
            });
            
            typeSelect.addEventListener('change', (e) => { 
                state.activeType = e.target.value; 
                updatePianoAndInfo(); 
                updateMatrixHighlightOnly(); 
                playCurrentChord(); 
            });
            
            inversionSelect.addEventListener('change', (e) => { 
                state.inversion = parseInt(e.target.value); 
                updatePianoAndInfo(); 
                playCurrentChord(); 
            });

            scaleContextSelect.addEventListener('change', (e) => { 
                state.scaleContext = e.target.value; 
                const rules = state.scaleContext === 'major' ? diatonicMajor : diatonicMinor;
                state.activeType = rules[0].tri; 
                updateMatrix(); 
                updatePianoAndInfo();
                updateMatrixHighlightOnly();
                playCurrentChord();
            });
            
            toggleSoundBtn.addEventListener('click', toggleAudio);
        }

        function generatePiano() {
            pianoContainer.innerHTML = '';
            const octaves = 3; 

            for (let oct = 0; oct < octaves; oct++) {
                const octaveOffset = oct * 12;
                
                const pattern = [
                    { type: 'w', n: 0 }, { type: 'b', n: 1, pos: 0 },
                    { type: 'w', n: 2 }, { type: 'b', n: 3, pos: 1 },
                    { type: 'w', n: 4 },
                    { type: 'w', n: 5 }, { type: 'b', n: 6, pos: 2 },
                    { type: 'w', n: 7 }, { type: 'b', n: 8, pos: 3 },
                    { type: 'w', n: 9 }, { type: 'b', n: 10, pos: 4 },
                    { type: 'w', n: 11 }
                ];

                pattern.forEach(k => {
                    const absNote = k.n + octaveOffset;
                    const div = document.createElement('div');
                    div.dataset.note = absNote;
                    
                    if (k.type === 'w') {
                        div.className = 'white-key';
                        if (k.n === 0) div.innerHTML = `<span class="note-label">C${oct+3}</span>`;
                    } else {
                        div.className = `black-key bk-pos-${k.pos}`;
                        const octavePixels = oct * 7 * (42 + 1); 
                        const offsetBase = 43; 
                        let localOffset = 0;
                        if(k.n === 1) localOffset = offsetBase * 1 - 14;
                        if(k.n === 3) localOffset = offsetBase * 2 - 14;
                        if(k.n === 6) localOffset = offsetBase * 4 - 14;
                        if(k.n === 8) localOffset = offsetBase * 5 - 14;
                        if(k.n === 10) localOffset = offsetBase * 6 - 14;
                        div.style.left = (octavePixels + localOffset) + 'px';
                    }

                    // INTERACTIVITY
                    div.addEventListener('mousedown', async () => {
                        // Attempt wake up if allowed
                        if (isAudioEnabled && audioCtx && audioCtx.state === 'suspended') {
                            await audioCtx.resume();
                        } else if (isAudioEnabled && !audioCtx) {
                            initAudio(); 
                        }
                        
                        playFreq(getFrequency(absNote), 0.5);
                        state.activeRoot = absNote % 12;
                        updatePianoAndInfo();
                        updateMatrixHighlightOnly();
                    });

                    pianoContainer.appendChild(div);
                });
            }
        }

        async function playCurrentChord() {
            // Only wake up if master switch is ON
            if (isAudioEnabled) {
                if (!audioCtx) await initAudio();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
            } else {
                return; // Stop here if muted
            }

            const activeKeys = document.querySelectorAll('.active');
            let delay = 0;
            activeKeys.forEach(k => {
                const noteIdx = parseInt(k.dataset.note);
                playFreq(getFrequency(noteIdx), 2, delay);
                delay += 0.05; 
            });
        }

        function updateAll() {
            updatePianoAndInfo();
            updateMatrix();
        }

        function updatePianoAndInfo() {
            const def = chordDefinitions[state.activeType];
            typeSelect.value = state.activeType; 
            
            // 1. Calculate relative Inversions (Handles both UP and DOWN)
            let relativeIntervals = [...def.intervals];
            
            if (state.inversion > 0) {
                // Invert UP (shift)
                for(let i=0; i<state.inversion; i++) {
                    const note = relativeIntervals.shift();
                    relativeIntervals.push(note + 12);
                }
            } else if (state.inversion < 0) {
                // Invert DOWN (unshift) - take top note, drop 12, move to front
                for(let i=0; i<Math.abs(state.inversion); i++) {
                    const note = relativeIntervals.pop();
                    relativeIntervals.unshift(note - 12);
                }
            }

            // 2. INTELLIGENT CENTERING LOGIC
            // Default offset to place Root roughly at C4 (Index 12)
            let octaveShift = 12;

            // Check if calculation puts notes out of bounds (0-35)
            // We calculate temporary absolute notes to check range
            let tempNotes = relativeIntervals.map(i => state.activeRoot + i + octaveShift);
            
            // If highest note goes beyond 35 (max index), shift whole chord down
            if (Math.max(...tempNotes) > 35) {
                octaveShift -= 12;
            }
            // If lowest note is below 0, shift whole chord up
            if (Math.min(...tempNotes) < 0) {
                octaveShift += 12;
            }

            // 3. Apply final calculation
            const absNotes = relativeIntervals.map(i => state.activeRoot + i + octaveShift);

            // 4. Update UI Texts
            const rootName = getNoteName(state.activeRoot, state.contextRoot); 
            document.getElementById('chordNameDisplay').textContent = `${rootName} ${def.name}`;
            document.getElementById('intervalsDisplay').textContent = def.struct;
            document.getElementById('theoryDesc').textContent = def.desc;
            
            const noteNames = absNotes.map(n => getNoteName(n, state.contextRoot)); // getNoteName handles mod 12
            document.getElementById('notesDisplay').textContent = noteNames.join(' - ');

            // 5. Highlight Keys
            document.querySelectorAll('.white-key, .black-key').forEach(k => {
                k.classList.remove('active');
                if(k.dataset.note % 12 === 0) k.innerHTML = `<span class="note-label">C${Math.floor(k.dataset.note/12)+3}</span>`;
                else k.innerHTML = '';
            });

            absNotes.forEach((noteIdx, i) => {
                // We now use the exact noteIdx because we normalized it to fit the 3 octaves
                const key = document.querySelector(`div[data-note="${noteIdx}"]`);
                if (key) {
                    key.classList.add('active');
                    key.innerHTML = ''; 
                    const label = document.createElement('span');
                    label.className = "note-label text-blue-200";
                    label.innerText = noteNames[i];
                    key.appendChild(label);
                }
            });
        }

        function updateMatrix() {
            matrixBody.innerHTML = '';
            const rules = state.scaleContext === 'major' ? diatonicMajor : diatonicMinor;
            
            const rootNameForTitle = getNoteName(state.contextRoot);
            document.getElementById('scaleLabel').textContent = `${rootNameForTitle} ${state.scaleContext === 'major' ? 'Dur' : 'Nat. Moll'}`;

            rules.forEach((rule, idx) => {
                const absNote = (state.contextRoot + rule.off) % 12;
                const noteName = getNoteName(absNote, state.contextRoot);

                const tr = document.createElement('tr');
                tr.className = "matrix-row border-b border-slate-800 transition-colors cursor-pointer";
                tr.dataset.root = absNote; 
                tr.dataset.triad = rule.tri;
                tr.dataset.seventh = rule.sev;

                highlightRow(tr, absNote, rule.tri, rule.sev);

                tr.onclick = () => quickSet(absNote, rule.tri);

                const html = `
                    <td class="px-4 py-3 text-slate-500 font-mono text-xs">${idx + 1}</td>
                    <td class="px-4 py-3 font-bold text-slate-300">${rule.step} <span class="text-xs font-normal text-slate-500 ml-1">(${noteName})</span></td>
                    <td class="px-4 py-3 text-xs">${rule.func}</td>
                    <td class="px-4 py-3 font-mono text-blue-400 hover:text-white transition-colors nav-cell-triad">
                        ${noteName}${rule.tri}
                    </td>
                    <td class="px-4 py-3 font-mono text-indigo-400 hover:text-white transition-colors nav-cell-seventh" onclick="event.stopPropagation(); quickSet(${absNote}, '${rule.sev}')">
                         ${noteName}${rule.sev}
                    </td>
                `;
                tr.innerHTML = html;
                matrixBody.appendChild(tr);
            });
        }

        function updateMatrixHighlightOnly() {
            const rows = document.querySelectorAll('.matrix-row');
            rows.forEach(tr => {
                const rowRoot = parseInt(tr.dataset.root);
                const rowTri = tr.dataset.triad;
                const rowSev = tr.dataset.seventh;
                highlightRow(tr, rowRoot, rowTri, rowSev);
            });
        }

        function highlightRow(tr, rowRoot, rowTri, rowSev) {
            tr.classList.remove('active-row', 'bg-slate-800');
            
            if (rowRoot === state.activeRoot) {
                tr.classList.add('bg-slate-800');
                if (state.activeType === rowTri || state.activeType === rowSev) {
                    tr.classList.add('active-row');
                }
            }
        }

        function quickSet(root, type) {
            state.activeRoot = root;
            state.activeType = type;
            state.inversion = 0;
            // Update UI to match reset inversion
            inversionSelect.value = 0; 
            
            updatePianoAndInfo();
            updateMatrixHighlightOnly();
            playCurrentChord();
        }

        init();
    </script>
</body>
</html>